<!DOCTYPE html>

<html>
<head>
  <title>client.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="client.html">
                client.js
              </a>
            
              
              <a class="source" href="server.html">
                server.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>client.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <pre><code>Client <span class="hljs-number">3.0</span><span class="hljs-number">.0</span>-Alpha1-SNAPSHOT
http:<span class="hljs-comment">//atmosphere.github.io/vibe/</span>

Copyright <span class="hljs-number">2014</span>-<span class="hljs-number">2014</span>, Donghwan Kim 
Licensed under the Apache License, Version <span class="hljs-number">2.0</span>
http:<span class="hljs-comment">//www.apache.org/licenses/LICENSE-2.0</span>
</code></pre>
            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>This is the client-side reference implementation of the 
<a href="http://atmosphere.github.io/vibe/">Vibe protocol</a> written in
easy-to-read JavaScript running on Node.js.</p>
<p><strong>Note</strong></p>
<ul>
<li>For production use, see the Vibe JavaScript Client.</li>
<li>Transports running only on browser are not implemented.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> events      = <span class="hljs-built_in">require</span>(<span class="hljs-string">"events"</span>),
    url         = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>), 
    uuid        = <span class="hljs-built_in">require</span>(<span class="hljs-string">"node-uuid"</span>),
    crypto      = <span class="hljs-built_in">require</span>(<span class="hljs-string">"crypto"</span>),
    WebSocket   = <span class="hljs-built_in">require</span>(<span class="hljs-string">"ws"</span>),
    http        = <span class="hljs-built_in">require</span>(<span class="hljs-string">"http"</span>),
    EventSource = <span class="hljs-built_in">require</span>(<span class="hljs-string">"eventsource"</span>);

http.globalAgent.maxSockets = <span class="hljs-literal">Infinity</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <h2 id="api">API</h2>
<p><code>require(&quot;vibe-protocol&quot;).open</code> opens a new socket and returns it.</p>
<pre><code><span class="hljs-keyword">var</span> vibe = <span class="hljs-built_in">require</span>(<span class="hljs-string">"vibe-protocol"</span>),
<span class="hljs-keyword">var</span> socket = vibe.open(<span class="hljs-string">"http://localhost:8080/vibe"</span>, {
    transport: <span class="hljs-string">"ws"</span>
});

socket.on(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
  socket.send(<span class="hljs-string">"greetings"</span>, <span class="hljs-string">"Hi"</span>);
});
</code></pre>
            </div>
            
            <div class="content"><div class='highlight'><pre>module.exports = socket;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <h2 id="uri">URI</h2>
<p>An URI is the complete path to the vibe server endpoint. The protocol uses
the query string to pass information to interact with the server in <code>GET</code>
request so be aware of reserved parameters.</p>
<h3 id="params">Params</h3>
<p>The followings are always included to the query string:</p>
<ul>
<li><code>id</code>: a socket id in the form of UUID.</li>
<li><code>when</code>: a goal of request.</li>
<li><code>_</code>: a random string for anti-caching.</li>
</ul>
<p>The <code>when</code> can be one of the followings and according to that value,
additional params are attached to query string.</p>
<ul>
<li><code>open</code>: to establish a connection.<ul>
<li><code>transport</code>: a transport id being used. It can be one of the followings:<ul>
<li><code>ws</code>: WebSocket.</li>
<li><code>sse</code>: Server-Sent Events.</li>
<li><code>streamxhr</code>: XMLHttpRequest Streaming.</li>
<li><code>streamxdr</code>: XDomainRequest Streaming. </li>
<li><code>streamiframe</code>: Hidden Iframe Streaming. </li>
<li><code>longpollajax</code>: AJAX Long Polling. </li>
<li><code>longpollxdr</code>: XDomainRequest Long Polling. </li>
<li><code>longpolljsonp</code>: JSONP Long Polling. </li>
</ul>
</li>
<li><code>heartbeat</code>: a heartbeat interval value in milliseconds. It have to be larger than <code>5000</code>.<ul>
<li><code>20000</code>: a recommended value.</li>
<li><code>false</code>: no heartbeat.</li>
</ul>
</li>
<li><code>callback</code>: a callback name used in <code>longpolljsonp</code> transport.</li>
</ul>
</li>
<li><code>poll</code>: to supply long polling transport with a new HTTP exchange.<ul>
<li><code>lastEventIds</code>: a comma-separated value of an id of the client-received 
events in the preceding response.</li>
</ul>
</li>
<li><code>abort</code>: to notify the server of disconnection of HTTP transports.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">uri</span><span class="hljs-params">(uri, params)</span> {</span>
    <span class="hljs-keyword">var</span> urlObj = url.parse(uri, <span class="hljs-literal">true</span>);
    urlObj.query = urlObj.query || {};
    
    urlObj.query.id = params.id;
    urlObj.query.when = params.when;
    urlObj.query._ = crypto.randomBytes(<span class="hljs-number">3</span>).toString(<span class="hljs-string">"hex"</span>);
    
    <span class="hljs-keyword">switch</span> (params.when) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">"open"</span>:
        urlObj.query.transport = params.transport;
        urlObj.query.heartbeat = params.heartbeat;
        <span class="hljs-keyword">if</span> (params.callback) {
            urlObj.query.callback = params.callback;
        }
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"poll"</span>:
        urlObj.query.lastEventIds = params.lastEventIds;
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">"abort"</span>:
        <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-keyword">delete</span> urlObj.search;
    <span class="hljs-keyword">return</span> url.format(urlObj);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <h2 id="socket">Socket</h2>
<p>A socket is a connectivity between the two vibe endpoints and an interface
for developers creating vibe applications.</p>
<p><strong>Options</strong></p>
<ul>
<li><code>transport:string</code>: a transport id.</li>
<li><code>heartbeat:number</code>: a heartbeat interval value in milliseconds.</li>
</ul>
<p><strong>Events</strong></p>
<ul>
<li><code>open()</code>: when the socket has been opened.</li>
<li><code>close()</code>: when the socket has been closed.</li>
<li>Any event can be used and exchanged unless their name is <code>open</code>, <code>close</code>, 
<code>reply</code> or <code>heartbeat</code> and can have <code>data:any</code> as a first arg and 
<code>reply:reply</code> to handle the client’s callback as a second arg.</li>
</ul>
<p><strong>Methods</strong></p>
<ul>
<li><code>send(event: string)</code>: sends an event.</li>
<li><code>send(event: string, data: any)</code>: sends an event with data.</li>
<li><code>send(event: string, data: any, resolved: function(arg: any), 
rejected: function(arg: any))</code>: sends an event with data attaching 
resolved and rejected callbacks to be called by the server.</li>
<li><code>close()</code>: closes the socket.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">socket</span><span class="hljs-params">(u, options)</span> {</span>
    <span class="hljs-keyword">var</span> socket = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Set default options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options.heartbeat = options.heartbeat || <span class="hljs-literal">false</span>;
    options._heartbeat = options._heartbeat || <span class="hljs-number">5000</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <h3 id="id">id</h3>
<p>Generate an UUID as an identifier of this socket. It should be
universally unique literally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.id = uuid.v4();</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <h3 id="handling-transport">Handling transport</h3>
<p>The transport attempts to connect to the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> params = {id: socket.id, transport: options.transport, heartbeat: options.heartbeat},
        transport = transports[options.transport](u, params);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Delegates transport’s <code>open</code> and <code>close</code> events to socket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transport.on(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        socket.emit(<span class="hljs-string">"open"</span>);
    });
    transport.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        socket.emit(<span class="hljs-string">"close"</span>);
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Fires an event if the underlying transport has received a message 
from the server.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transport.on(<span class="hljs-string">"message"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(text)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The latch prevents double reply.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> latch,</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Converts JSON text to an event object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            event = <span class="hljs-built_in">JSON</span>.parse(text);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <h4 id="an-event-sent-by-the-server">An event sent by the server</h4>
<p>It should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: true if this event requires the reply.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        socket.emit(event.type, event.data, !event.reply ? <span class="hljs-literal">null</span> : {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Calls the server’s resolved callback whose event id is <code>event.id</code> with <code>value</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            resolve: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(value)</span> {</span>
                <span class="hljs-keyword">if</span> (!latch) {
                    latch = <span class="hljs-literal">true</span>;
                    socket.send(<span class="hljs-string">"reply"</span>, {id: event.id, data: value, exception: <span class="hljs-literal">false</span>});
                }
            },</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Calls the server’s rejected callback whose event id is <code>event.id</code> with <code>reason</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            reject: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(reason)</span> {</span>
                <span class="hljs-keyword">if</span> (!latch) {
                    latch = <span class="hljs-literal">true</span>;
                    socket.send(<span class="hljs-string">"reply"</span>, {id: event.id, data: reason, exception: <span class="hljs-literal">true</span>});
                }
            }
        });
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>A map for reply callbacks to be handled by the client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> callbacks = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <h3 id="send">send</h3>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.send = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(type, data, resolved, rejected)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <h4 id="an-event-to-be-sent-to-the-server">An event to be sent to the server</h4>
<p>It should have the following properties:</p>
<ul>
<li><code>id: string</code>: an event identifier.</li>
<li><code>type: string</code>: an event type.</li>
<li><code>data: any</code>: an event data.</li>
<li><code>reply: boolean</code>: true if this event requires the reply.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> event = {
                id: crypto.randomBytes(<span class="hljs-number">3</span>).toString(<span class="hljs-string">"hex"</span>), 
                type: type, 
                data: data, 
                reply: !!(resolved || rejected)
            };</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Stores resolved and rejected callbacks if they are given.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (event.reply) {
            callbacks[event.id] = {resolved: resolved, rejected: rejected};
        }</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Convert event object to JSON string and sends it through the transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.send(<span class="hljs-built_in">JSON</span>.stringify(event));
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <h3 id="close">close</h3>
<p>By closing the transport.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        transport.close();
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <h3 id="reply">reply</h3>
<p>If the server sends the reply event, executes the stored reply
callbacks with data and deletes it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">"reply"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(reply)</span> {</span>
        <span class="hljs-keyword">if</span> (reply.id <span class="hljs-keyword">in</span> callbacks) {
            <span class="hljs-keyword">var</span> cbs = callbacks[reply.id],
                fn = reply.exception ? cbs.rejected : cbs.resolved;
            <span class="hljs-keyword">if</span> (fn) {
                fn.call(<span class="hljs-keyword">this</span>, reply.data);
            }
            <span class="hljs-keyword">delete</span> callbacks[reply.id];
        }
    });</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h3 id="heartbeat">heartbeat</h3>
<p>If <code>heartbeat</code> option is not <code>false</code> and is a number, starts
the heartbeat handshakes on <code>open</code> event. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    socket.on(<span class="hljs-string">"open"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>The option <code>_heartbeat</code> is just to speed up heartbeat test and do not
provide such option for production use. It means the time to wait
for the server’s response. The default value is <code>5000</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span> (options.heartbeat &gt; options._heartbeat) {
            <span class="hljs-keyword">var</span> heartbeatTimer;
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setHeartbeatTimer</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Sets a timer to send an heartbeat event after
<code>heartbeat - _heartbeat</code> miliseconds.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                heartbeatTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    socket.send(<span class="hljs-string">"heartbeat"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Sets a timer to close the socket if the server doesn’t
respond in the <code>_heartbeat</code> interval.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    heartbeatTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                        socket.close();
                    }, options._heartbeat);
                }, options.heartbeat - options._heartbeat);
            }</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>If the server echoes back the sent heartbeat event, clear the timer
and set it again.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            socket.on(<span class="hljs-string">"heartbeat"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                clearTimeout(heartbeatTimer);
                setHeartbeatTimer();
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>The heartbeat handshake should be stopped on close event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            socket.on(<span class="hljs-string">"close"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                clearTimeout(heartbeatTimer);
            });</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Starts the heartbeat.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            setHeartbeatTimer();
        }
    });
    
    <span class="hljs-keyword">return</span> socket;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <h2 id="transport">Transport</h2>
<p>A transport hides internal techniques and policies for Comet 
or WebSocket and provides a simple view of frame-based connection.</p>
<p><strong>Events</strong></p>
<ul>
<li><code>open()</code>: when the transport has been opened. </li>
<li><code>close()</code>: when the transport has been closed. </li>
<li><code>message(data: string)</code>: when the transport has received data. </li>
</ul>
<p><strong>Methods</strong></p>
<ul>
<li><code>send(data: string)</code>: sends data.</li>
<li><code>close()</code>: closes the transport.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">var</span> transports = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <h3 id="websocket">WebSocket</h3>
<p><code>ws</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>transports.ws = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(u, params)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Builds an URI to open changing the protocol from http to ws and connects
to the server over WebSocket protocol.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> ws = <span class="hljs-keyword">new</span> WebSocket(uri(u, {id: params.id, when: <span class="hljs-string">"open"</span>, transport: <span class="hljs-string">"ws"</span>, heartbeat: params.heartbeat}).replace(<span class="hljs-regexp">/^http/</span>, <span class="hljs-string">"ws"</span>)),
        transport = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Simply delegates WebSocket’s events to transport and transport’s
behaviors to WebSocket.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ws.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        transport.emit(<span class="hljs-string">"open"</span>);
    };
    ws.onclose = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        transport.emit(<span class="hljs-string">"close"</span>);
    };
    ws.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        transport.emit(<span class="hljs-string">"message"</span>, event.data);
    };
    transport.send = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span>
        ws.send(data);
    };
    transport.close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        ws.close();
    };
    <span class="hljs-keyword">return</span> transport;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <h3 id="http-base">HTTP base</h3>
<p>A base transport for HTTP transports.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>transports.httpbase = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(u, params)</span> {</span>
    <span class="hljs-keyword">var</span> transport = <span class="hljs-keyword">new</span> events.EventEmitter();</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <h4 id="send">send</h4>
<p>A persistent connection established by transport over HTTP protocol is
only for the server to send something to the client. For the client to
send something to the server, use a plain HTTP client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transport.send = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Final data is prefixed with <code>data=</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        data = <span class="hljs-string">"data="</span> + data;
        <span class="hljs-keyword">var</span> urlObj = url.parse(u, <span class="hljs-literal">true</span>);
        urlObj.query = urlObj.query || {};</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Adds a <code>id</code> param indicating this socket’s id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        urlObj.query.id = params.id;
        <span class="hljs-keyword">var</span> reqOpts = url.parse(url.format(urlObj));</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>This channel should use <code>POST</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        reqOpts.method = <span class="hljs-string">"POST"</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Writes data with <code>utf-8</code> encoding. It is default
one in Node.js wisely.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        http.request(reqOpts).end(data);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h4 id="close">close</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transport.close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Aborts the real connection. It should be implemented by others.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.abort();</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Notifies the server of disconnection of this connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        http.get(url.parse(uri(u, {id: params.id, when: <span class="hljs-string">"abort"</span>})));
    };
    <span class="hljs-keyword">return</span> transport;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <h3 id="streaming-by-server-sent-events">Streaming by Server-Sent Events</h3>
<p><code>sse</code>.</p>
<p>The server-sent events introduced in HTML5 is just yet another HTTP streaming
technique.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>transports.sse = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(u, params)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Builds an URI to open and connects to the server over HTTP protocol.
EventSource uses <code>GET</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">var</span> es = <span class="hljs-keyword">new</span> EventSource(uri(u, {id: params.id, when: <span class="hljs-string">"open"</span>, transport: <span class="hljs-string">"sse"</span>, heartbeat: params.heartbeat})),
        transport = transports.httpbase(u, params);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Simply delegates EventSource’s events to transport and transport’s
behaviors to EventSource.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    es.onopen = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        transport.emit(<span class="hljs-string">"open"</span>);
    };
    es.onmessage = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        transport.emit(<span class="hljs-string">"message"</span>, event.data);
    };
    es.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
        es.close();
        transport.emit(<span class="hljs-string">"close"</span>);
    };</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <h4 id="abort">abort</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transport.abort = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>By aborting the EventSource.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        es.close();</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>EventSource doesn’t notify of disconnection. So fires the
closes event immediately.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.emit(<span class="hljs-string">"close"</span>);
    };
    <span class="hljs-keyword">return</span> transport;
};</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <h3 id="streaming-by-xmlhttprequest-xdomainrequest-or-hidden-iframe">Streaming by XMLHttpRequest, XDomainRequest or Hidden iframe</h3>
<p><code>streamxhr</code>, <code>streamxdr</code> and <code>streamiframe</code>.</p>
<p>Their difference is which host object initiates and progresses a connection
in browser. Therefore, client not running on browser like Java
client don’t have to implement them. <code>sse</code> is enough for streaming. To pass
the test suite, just assign <code>sse</code> instead of them when they are requested.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>[<span class="hljs-string">"streamxhr"</span>, <span class="hljs-string">"streamxdr"</span>, <span class="hljs-string">"streamiframe"</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tpName)</span> {</span>
    transports[tpName] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(u, params)</span> {</span>
        <span class="hljs-keyword">var</span> req,
            transport = transports.httpbase(u, params);</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Performs a persistent HTTP connection via <code>GET</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        req = http.get(uri(u, {id: params.id, when: <span class="hljs-string">"open"</span>, transport: tpName, heartbeat: params.heartbeat}))</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>If any error is encountered, fires the close event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            transport.emit(<span class="hljs-string">"close"</span>);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Technically the open event should be fired by the first chunk,
padding, but non-browser client doesn’t need to do that because
it can detect when the response headers have been received.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .on(<span class="hljs-string">"response"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span> {</span>
            transport.emit(<span class="hljs-string">"open"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Every chunk may be a single event, multiple events or a fragment
of a single event. This buffer helps handle fragments.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-keyword">var</span> buffer = <span class="hljs-string">""</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Chunks are formatted according to the <a href="http://www.w3.org/TR/eventsource/#event-stream-interpretation">event stream
format</a>.
However, you don’t need to know that. A single event starts with
‘data: ‘ and ends with <code>\n\n</code>. That’s all you need to know.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            res.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chunk)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Strips off the left padding of the chunk that appears in the
first chunk.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                chunk = chunk.toString().replace(<span class="hljs-regexp">/^\s+/</span>, <span class="hljs-string">""</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>If the chunk consists of only whitespace characters, there is
nothing to do.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">if</span> (!chunk) {
                    <span class="hljs-keyword">return</span>;
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Let’s think of a series of the following chunks:</p>
<ul>
<li><code>&quot;data: {}\n\ndata: {}\n\n&quot;</code></li>
<li><code>&quot;data: {}\n\ndata: {&quot;</code></li>
<li><code>&quot;}\n\ndata:{&quot;</code></li>
<li><code>&quot;..&quot;</code></li>
<li><code>&quot;.}&quot;</code></li>
<li><code>&quot;\n\ndata: {}\n\n&quot;</code></li>
</ul>
<p>It looks not easy to handle. So let’s concatenate buffer and chunk. 
Here the buffer is a string after last <code>\n\n</code> of the concatenation.</p>
<ul>
<li><code>&quot;&quot;</code> + <code>&quot;data: {}\n\ndata: {}\n\n&quot;</code></li>
<li><code>&quot;&quot;</code> + <code>&quot;data: {}\n\ndata: {&quot;</code></li>
<li><code>&quot;data: {&quot;</code> + <code>&quot;}\n\ndata:{&quot;</code></li>
<li><code>&quot;data: {&quot;</code> + <code>&quot;..&quot;</code></li>
<li><code>&quot;data: {..&quot;</code> + <code>&quot;.}&quot;</code></li>
<li><code>&quot;data: {...}&quot;</code> + <code>&quot;\n\ndata: {}\n\n&quot;</code></li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Let’s split the concatenation by <code>\n\n</code>. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">var</span> i, lines = (buffer + chunk).split(<span class="hljs-string">"\n\n"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Lines except the last consist of a complete data starting 
with ‘data: ‘ Unwraps ‘data: ‘ and fires a message event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; lines.length - <span class="hljs-number">1</span>; i++) {
                    transport.emit(<span class="hljs-string">"message"</span>, lines[i].substring(<span class="hljs-string">"data: "</span>.length));
                }</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>The last element is a fragment of a data. Assigns it to buffer.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                buffer = lines[lines.length - <span class="hljs-number">1</span>];
            })
            .on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                transport.emit(<span class="hljs-string">"close"</span>);
            });
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <h4 id="abort">abort</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>        transport.close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>By aborting the current client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            req.abort();
        };
        <span class="hljs-keyword">return</span> transport;
    };
});</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h3 id="long-polling-by-ajax-xdomainrequest">Long polling by AJAX, XDomainRequest</h3>
<p><code>longpollajax</code> and <code>longpollxdr</code>.</p>
<p>Their difference is which host object initiates and progresses a connection
in browser. Therefore, client not running on browser like Java client don’t
have to implement <code>longpollxdr</code>. <code>longpollajax</code> is enough for long polling.
To pass the test suite, just assign <code>longpollajax</code> instead of <code>longpollxdr</code>
when it is requested.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>[<span class="hljs-string">"longpollajax"</span>, <span class="hljs-string">"longpollxdr"</span>].forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(tpName)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>In long polling, a pseudo-connection consisting of disposable HTTP exchanges
pretends to be a persistent connection.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    transports[tpName] = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(u, params)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>The current HTTP client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">var</span> req,
            transport = transports.httpbase(u, params);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h4 id="open">open</h4>
<p>The first request is to open and subsequent requests are to poll. All
they use <code>GET</code> method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        req = http.get(uri(u, {id: params.id, when: <span class="hljs-string">"open"</span>, transport: tpName, heartbeat: params.heartbeat}))</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>If any error is encountered during the request, that means the
server is not available. So fires the close event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
            transport.emit(<span class="hljs-string">"close"</span>);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>If the server is available so the first request is completed normally,
start to poll and fire the open event. To pretend a persistent connection
properly, there must be no idle time between the poll.
Therefore, always starting poll request is prior to dispatching events.
Otherwise, the user might see the connection is not operational
occasionally.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .on(<span class="hljs-string">"response"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>For the first time, starts with empty array.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            poll([]);</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>The poll request is started so fire the open event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            transport.emit(<span class="hljs-string">"open"</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <h4 id="poll">poll</h4>
<p>From the second request, <code>when</code> is <code>poll</code> and <code>lastEventIds</code> is
needed that is a CSV of event ids in the preceding request’s response
is needed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">poll</span><span class="hljs-params">(lastEventIds)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>FYI, <code>[&quot;x&quot;, &quot;y&quot;, &quot;z&quot;].join(&quot;,&quot;)</code> gives <code>&quot;x,y,z&quot;</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                req = http.get(uri(u, {id: params.id, when: <span class="hljs-string">"poll"</span>, lastEventIds: lastEventIds.join(<span class="hljs-string">","</span>)}))</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>This is the same with the open request’s error event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                .on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    transport.emit(<span class="hljs-string">"close"</span>);
                })</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>If the server responds to the request, determine whether the
intention of response is to send event or to close.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                .on(<span class="hljs-string">"response"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Reads body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">var</span> body = <span class="hljs-string">""</span>;
                    res.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chunk)</span> {</span>
                        body += chunk;
                    });
                    res.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>If body exists, it is a JSON string representing the
server-sent events.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        <span class="hljs-keyword">if</span> (body) {</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>To prepare the next request, identify events in the
response and collect their ids.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">var</span> eventIds = [], obj = <span class="hljs-built_in">JSON</span>.parse(body);</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>If the parsed object is an array, it contains events
that the client couldn’t receive before.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(obj)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>An array of multiple event ids. FYI,
<code>[{id:1},{id:2},{id:3}].map(function(e) {return
e.id;})</code> gives <code>[1,2,3]</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                eventIds = obj.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
                                    <span class="hljs-keyword">return</span> event.id;
                                });</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Otherwise, it’s a plain event object.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>An array of a single event id.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                eventIds = [obj.id];
                            }</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Sends a poll request again before to fire events.
Again call order is important.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                            poll(eventIds);
                            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(obj)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>It’s uncomfortable to stringify parsed object
again but anyway fire a message event to the
socket with stringified event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                obj.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
                                    transport.emit(<span class="hljs-string">"message"</span>, <span class="hljs-built_in">JSON</span>.stringify(event));
                                });
                            } <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Fires a message event with that string body.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                                transport.emit(<span class="hljs-string">"message"</span>, body);
                            }</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>If the server closed the socket, body becomes absent.
Accordingly fires the close event.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        } <span class="hljs-keyword">else</span> {
                            transport.emit(<span class="hljs-string">"close"</span>);
                        }
                    });
                });
            }
        });</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <h4 id="abort">abort</h4>

            </div>
            
            <div class="content"><div class='highlight'><pre>         transport.close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>By aborting the current client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>            req.abort();
        };
        <span class="hljs-keyword">return</span> transport;
    };
});</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <h3 id="long-polling-by-jsonp">Long polling by JSONP</h3>
<p><code>longpolljsonp</code>.</p>
<p>Except request’s callback param, response’s content-type header and its body,
<code>longpolljsonp</code> and <code>longpollajax</code> are all the same. So duplicated comments
are removed.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>transports.longpolljsonp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(u, params)</span> {</span>
    <span class="hljs-keyword">var</span> req,
        transport = transports.httpbase(u, params);</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>Adds the callback param. In browser response body can’t be controlled so
it should be unique.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    req = http.get(uri(u, {id: params.id, when: <span class="hljs-string">"open"</span>, transport: <span class="hljs-string">"longpolljsonp"</span>, callback: <span class="hljs-string">"dayoff"</span>, heartbeat: params.heartbeat}))
    .on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        transport.emit(<span class="hljs-string">"close"</span>);
    })
    .on(<span class="hljs-string">"response"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        poll([]);
        transport.emit(<span class="hljs-string">"open"</span>);
        <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">poll</span><span class="hljs-params">(lastEventIds)</span> {</span>
            req = http.get(uri(u, {id: params.id, when: <span class="hljs-string">"poll"</span>, lastEventIds: lastEventIds.join(<span class="hljs-string">","</span>)}))
            .on(<span class="hljs-string">"error"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                transport.emit(<span class="hljs-string">"close"</span>);
            })
            .on(<span class="hljs-string">"response"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(res)</span> {</span>
                <span class="hljs-keyword">var</span> body = <span class="hljs-string">""</span>;
                res.on(<span class="hljs-string">"data"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chunk)</span> {</span>
                    body += chunk;
                });
                res.on(<span class="hljs-string">"end"</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
                    <span class="hljs-keyword">if</span> (body) {</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>The returned body is a JavaScript code snippet executing 
the callback with data. In browser it will be executed 
immediately. Here we can manipulate the body so retrieve 
the real data by stripping function call experession 
and unescpaing it as JSON.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>                        body = <span class="hljs-built_in">JSON</span>.parse(body.match(<span class="hljs-regexp">/^dayoff\((.*)\);$/</span>)[<span class="hljs-number">1</span>]);
                        <span class="hljs-keyword">var</span> eventIds = [], obj = <span class="hljs-built_in">JSON</span>.parse(body);
                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(obj)) {
                            eventIds = obj.map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
                                <span class="hljs-keyword">return</span> event.id;
                            });
                        } <span class="hljs-keyword">else</span> {
                            eventIds = [obj.id];
                        }
                        poll(eventIds);
                        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(obj)) {
                            obj.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(event)</span> {</span>
                                transport.emit(<span class="hljs-string">"message"</span>, <span class="hljs-built_in">JSON</span>.stringify(event));
                            });
                        } <span class="hljs-keyword">else</span> {
                            transport.emit(<span class="hljs-string">"message"</span>, body);
                        }
                    } <span class="hljs-keyword">else</span> {
                        transport.emit(<span class="hljs-string">"close"</span>);
                    }
                });
            });
        }
    });
     transport.close = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
        req.abort();
    };
    <span class="hljs-keyword">return</span> transport;
};</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
