/* Vibe v3.0.0-Alpha3 | http://vibe-project.github.io/projects/vibe-javascript-client/ | (c) 2014, The Vibe Project | http://www.apache.org/licenses/LICENSE-2.0 */
(function(h,u){if("function"===typeof define&&define.amd)define([],function(){return u(h)});else if("object"===typeof exports){var y=require("jsdom").jsdom().parentWindow;y.WebSocket=require("ws");y.EventSource=require("eventsource");module.exports=u(y);module.exports.util.corsable=!0}else h.vibe=u(h)})(this,function(h){function u(c){var b,a,f,g,d,k,e=[],h=function(h,m){m=m||[];a=!c||[h,m];f=!0;k=g||0;g=0;for(d=e.length;k<d&&!b;k++)e[k].apply(h,m);f=!1};return{add:function(c){var k=e.length;e.push(c);
f?d=e.length:!b&&a&&!0!==a&&(g=k,h(a[0],a[1]))},remove:function(a){var b;for(b=0;b<e.length;b++)if(a===e[b]||a.guid&&a.guid===e[b].guid)f&&b<=d&&(d--,b<=k&&k--),e.splice(b--,1)},fire:function(d,g){b||f||c&&a||h(d,g)},lock:function(){b=!0},locked:function(){return!!b},unlock:function(){b=a=f=g=d=k=void 0}}}function y(c,b){c=e.makeAbsolute(c);var a,f=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/.exec(c.toLowerCase()),g={reconnect:function(a){return 2*(a||250)},sharing:!1,timeout:!1,transports:null,
xdrURL:null};if(b)for(a in b)g[a]=b[a];b=g;b.url=c;b.crossOrigin=!(!f||f[1]==z.protocol&&f[2]==z.hostname&&(f[3]||("http:"===f[1]?80:443))==(z.port||("http:"===z.protocol?80:443)));var d={},k={};d.on=function(a,b){var d;d=k[a];if(!d){if(k.message.locked())return this;d=k[a]=u();d.order=k.message.order}d.add(b);return this};d.off=function(a,b){var d=k[a];d&&d.remove(b);return this};d.once=function(a,b){function c(){d.off(a,c);b.apply(d,arguments)}b.guid=b.guid||v++;c.guid=b.guid;return d.on(a,c)};
d.fire=function(a){var b=k[a];b&&b.fire(d,G.call(arguments,1));return this};var r;d.state=function(){return r};for(a in{connecting:1,open:1,close:1,waiting:1})k[a]=u(!0),k[a].order=v++;k.message=u(!1);k.message.order=k.open.order;d.on("connecting",function(){function a(){clearTimeout(g)}function f(){function a(b){b=e.parseJSON(b);if("p"===b.target)switch(b.type){case "send":b=e.parseJSON(b.data);d.send(b.type,b.data);break;case "close":d.close()}}function g(a){m.broadcast({target:"c",type:"message",
data:a})}function k(){p.cookie=encodeURIComponent(s)+"="+encodeURIComponent(e.stringifyJSON({ts:e.now(),heir:(m.get("children")||[])[0]}))+"; path=/"}var l,m,s="socket-"+c,t={storage:function(){var b=h.localStorage;if(!e.browser.msie)return{init:function(){function c(b){b.key===s&&b.newValue&&a(b.newValue)}e.on(h,"storage",c);d.once("close",function(){e.off(h,"storage",c);d.once("close",function(){b.removeItem(s);b.removeItem(s+"-opened");b.removeItem(s+"-children")})})},broadcast:function(d){var c=
e.stringifyJSON(d);b.setItem(s,c);setTimeout(function(){a(c)},50)},get:function(a){return e.parseJSON(b.getItem(s+"-"+a))},set:function(a,d){b.setItem(s+"-"+a,e.stringifyJSON(d))}}},windowref:function(){var b=s.replace(/\W/g,""),d=p.getElementById(b),c;d||(d=p.createElement("div"),d.id=b,d.style.display="none",d.innerHTML='<iframe name="'+b+'" />',p.body.appendChild(d));c=d.firstChild.contentWindow;return{init:function(){c.callbacks=[a];c.fire=function(b){var a;for(a=0;a<c.callbacks.length;a++)c.callbacks[a](b)}},
broadcast:function(b){!c.closed&&c.fire&&c.fire(e.stringifyJSON(b))},get:function(b){return c.closed?null:c[b]},set:function(b,a){c.closed||(c[b]=a)}}}};m=t.storage()||t.windowref();m.init();m.set("children",[]);m.set("opened",!1);k();l=setInterval(k,1E3);d.on("_message",g).once("open",function(){m.set("opened",!0);m.broadcast({target:"c",type:"open"})}).once("close",function(){clearInterval(l);p.cookie=encodeURIComponent(s)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";m.broadcast({target:"c",
type:"close",data:{heir:D?(m.get("children")||[])[0]:b.id}});d.off("_message",g)})}r="connecting";var g;0<b.timeout&&(g=setTimeout(function(){d.fire("error",Error("timeout"));n.close()},b.timeout),d.once("open",a).once("close",a));b.sharing&&!C&&f()}).on("open",function(){function a(){c=setTimeout(function(){d.send("heartbeat").once("heartbeat",function(){clearTimeout(c);a()});c=setTimeout(function(){d.fire("error",Error("heartbeat"));n.close()},b._heartbeat)},b.heartbeat-b._heartbeat)}r="opened";
var c;b.heartbeat>b._heartbeat&&(a(),d.once("close",function(){clearTimeout(c)}));k.connecting.lock();m=t=l=null}).on("close",function(){r="closed";var a,c,g=k.close.order;for(a in k)c=k[a],c.order<g&&c.lock();if(b.reconnect)d.once("close",function(){l=l||1;t=b.reconnect.call(d,t,l);!1!==t&&(m=setTimeout(function(){d.open()},t),d.fire("waiting",t,l))})}).on("waiting",function(){r="waiting"});var n,C,m,t,l;d.open=function(){var a;clearTimeout(m);for(a in k)k[a].unlock();n=C=null;r="preparing";l&&l++;
(function(a,c){var d=e.url(b.url,{when:"handshake"});if(!b.crossOrigin||e.corsable){var g=e.xhr();g.onreadystatechange=function(){4===g.readyState&&(200===g.status?a(e.parseJSON(g.responseText)):c())};g.open("GET",d);e.corsable&&(g.withCredentials=!0);g.send(null)}else{var f=A.pop()||"socket_"+v++;h[f]=function(b){a(e.parseJSON(b));h[f]=null;A.push(f)};var k=p.createElement("script");k.async=!0;k.src=d+"&callback="+f;k.onload=k.onreadystatechange=function(){if(!k.readyState||/loaded|complete/.test(k.readyState))k.onload=
k.onreadystatechange=null,k.parentNode&&k.parentNode.removeChild(k)};x.insertBefore(k,x.firstChild)}})(function(c){b.id=c.id;b.heartbeat=c.heartbeat;b.transports||(b.transports=c.transports);c._heartbeat&&(b._heartbeat=c._heartbeat);c=G.call(b.transports);for(b.sharing&&c.unshift("session");!n&&c.length;)switch(a=c.shift(),a){case "stream":c.unshift("sse","streamxhr","streamxdr","streamiframe");break;case "longpoll":c.unshift("longpollajax","longpollxdr","longpolljsonp");break;default:n=q[a](d,b)}n?
(b.transport=a,C="session"===a,d.fire("connecting"),n.open()):d.fire("error",Error("notransport")).fire("close")},function(){d.fire("error",Error("handshake")).fire("close")});return this};d.close=function(){b.reconnect=!1;clearTimeout(m);n&&n.close();return this};var E={};d.send=function(a,b,c,g){"opened"!==r&&d.fire(Error("notopened"));a={id:v++,type:a,data:b,reply:!(!c&&!g)};a.reply&&(E[a.id]=[c,g]);n.send(e.stringifyJSON(a));return this};d.receive=function(a){var b,c=e.parseJSON(a);a=[c.type,
c.data,c.reply?{resolve:function(a){b||(b=!0,d.send("reply",{id:c.id,data:a,exception:!1}))},reject:function(a){b||(b=!0,d.send("reply",{id:c.id,data:a,exception:!0}))}}:null];return d.fire.apply(d,a).fire("_message",a)};d.on("reply",function(a){E[a.id][+a.exception].call(d,a.data);delete E[a.id]});return d.open()}var v=1,D,G=Array.prototype.slice,F=Object.prototype.toString,H=Object.prototype.hasOwnProperty,p=h.document,z=h.location,I=h.navigator,e,A=[],x=p.head||p.getElementsByTagName("head")[0]||
p.documentElement;e={now:Date.now||function(){return+new Date},isArray:Array.isArray||function(c){return"[object Array]"===F.call(c)},isFunction:function(c){return"[object Function]"===F.call(c)},makeAbsolute:function(c){var b=p.createElement("div");b.innerHTML='<a href="'+c+'"/>';return encodeURI(decodeURI(b.firstChild.href))},on:function(c,b,a){c.addEventListener?c.addEventListener(b,a,!1):c.attachEvent&&c.attachEvent("on"+b,a)},off:function(c,b,a){c.removeEventListener?c.removeEventListener(b,
a,!1):c.detachEvent&&c.detachEvent("on"+b,a)},url:function(c,b){var a,f=[];b=b||{};b._=v++;for(a in b)f.push(encodeURIComponent(a)+"="+encodeURIComponent(b[a]));return c+(/\?/.test(c)?"&":"?")+f.join("&").replace(/%20/g,"+")},xhr:function(){try{return new h.XMLHttpRequest}catch(c){try{return new h.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}},parseJSON:h.JSON?h.JSON.parse:function(c){return Function("return "+c)()},stringifyJSON:h.JSON?h.JSON.stringify:function(c){function b(a){return'"'+a.replace(f,
function(a){var b=g[a];return"string"===typeof b?b:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"'}function a(a){return 10>a?"0"+a:a}var f=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,g={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return function k(c,g){var f,e,h,l=g[c];h=typeof l;l&&"object"===typeof l&&"function"===typeof l.toJSON&&(l=l.toJSON(c),h=typeof l);switch(h){case "string":return b(l);
case "number":return isFinite(l)?String(l):"null";case "boolean":return String(l);case "object":if(!l)return"null";switch(F.call(l)){case "[object Date]":return isFinite(l.valueOf())?'"'+l.getUTCFullYear()+"-"+a(l.getUTCMonth()+1)+"-"+a(l.getUTCDate())+"T"+a(l.getUTCHours())+":"+a(l.getUTCMinutes())+":"+a(l.getUTCSeconds())+'Z"':"null";case "[object Array]":e=l.length;h=[];for(f=0;f<e;f++)h.push(k(f,l)||"null");return"["+h.join(",")+"]";default:h=[];for(f in l)H.call(l,f)&&(e=k(f,l))&&h.push(b(f)+
":"+e);return"{"+h.join(",")+"}"}}}("",{"":c})}};e.corsable="withCredentials"in e.xhr();e.browser=function(){var c=I.userAgent.toLowerCase(),b={},c=/(msie) ([\w.]+)/.exec(c)||/(trident)(?:.*? rv:([\w.]+)|)/.exec(c)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(c)||0>c.indexOf("android")&&/version\/(.+) (safari)/.exec(c)||[];b[c[1]||""]=!0;b.version=c[2]||"0";b.vmajor=b.version.split(".")[0];b.trident&&(b.msie=!0);return b}();var q={session:function(c,b){function a(a,b){var c,d=a.length;for(c=0;c<d;c++)a[c]===
b&&a.splice(c,1);return d!==a.length}function f(a){a=e.parseJSON(a);var d=a.data;if("c"===a.target)switch(a.type){case "open":c.fire("open");break;case "close":k||(k=!0,d.heir===b.id?c.fire("close"):setTimeout(function(){c.fire("close")},100));break;case "message":if("connecting"===c.state())c.once("open",function(){c.fire.apply(c,d)});else c.fire.apply(c,d)}}function g(){var a=(new RegExp("(?:^|; )("+encodeURIComponent(n)+")=([^;]*)")).exec(p.cookie);if(a)return e.parseJSON(decodeURIComponent(a[2]))}
var d,k,r,n="socket-"+b.url,q={storage:function(){if(!e.browser.msie){var d=h.localStorage,g=function(a){return e.parseJSON(d.getItem(n+"-"+a))},k=function(a,b){d.setItem(n+"-"+a,e.stringifyJSON(b))};return{init:function(){function d(a){a.key===n&&a.newValue&&f(a.newValue)}k("children",g("children").concat([b.id]));e.on(h,"storage",d);c.once("close",function(){var c=g("children");e.off(h,"storage",d);c&&a(c,b.id)&&k("children",c)});return g("opened")},broadcast:function(a){var b=e.stringifyJSON(a);
d.setItem(n,b);setTimeout(function(){f(b)},50)}}}},windowref:function(){var d=h.open("",n.replace(/\W/g,""));if(d&&!d.closed&&d.callbacks)return{init:function(){d.callbacks.push(f);d.children.push(b.id);c.once("close",function(){k||(a(d.callbacks,f),a(d.children,b.id))});return d.opened},broadcast:function(a){!d.closed&&d.fire&&d.fire(e.stringifyJSON(a))}}}};if((d=g())&&!(1E3<e.now()-d.ts)&&(r=q.storage()||q.windowref()))return{open:function(){var a,k=b.timeout,h=b.heartbeat;b.timeout=b.heartbeat=
!1;a=setInterval(function(){var a=d;(d=g())&&a.ts!==d.ts||f(e.stringifyJSON({target:"c",type:"close",data:{heir:a.heir}}))},1E3);c.once("close",function(){clearInterval(a);b.timeout=k;b.heartbeat=h});r.init()&&setTimeout(function(){c.fire("open")},50)},send:function(a){r.broadcast({target:"p",type:"send",data:a})},close:function(){D||r.broadcast({target:"p",type:"close"})}}},base:function(c,b){var a={uri:{open:function(){return e.url(b.url,{id:b.id,when:"open",transport:b.transport})}},close:function(){a.abort();
var f=p.createElement("script");f.async=!1;f.src=e.url(b.url,{id:b.id,when:"abort"});f.onload=f.onerror=f.onreadystatechange=function(){if(!f.readyState||/loaded|complete/.test(f.readyState))f.onload=f.onreadystatechange=null,f.parentNode&&f.parentNode.removeChild(f),c.fire("close")};x.insertBefore(f,x.firstChild)}};return a},ws:function(c,b){var a,f=h.WebSocket,g=q.base(c,b);if(f)return g.open=function(){var b=g.uri.open().replace(/^http/,"ws");a=new f(b);a.onopen=function(){c.fire("open")};a.onmessage=
function(a){c.receive(a.data)};a.onerror=function(){g.fire("error",Error()).fire("close")};a.onclose=function(){c.fire("close")}},g.send=function(b){a.send(b)},g.abort=function(){a.close()},g},httpbase:function(c,b){function a(a){"opened"===c.state()&&f.send(a)}var f=q.base(c,b);f.send=!b.crossOrigin||e.corsable?function(c){var d=e.xhr();d.onreadystatechange=function(){4===d.readyState&&200!==d.status&&a(c)};d.open("POST",e.url(b.url,{id:b.id}));d.setRequestHeader("content-type","text/plain; charset=UTF-8");
e.corsable&&(d.withCredentials=!0);d.send("data="+c)}:h.XDomainRequest&&b.xdrURL?function(g){var d=new h.XDomainRequest;d.onerror=function(){a(g)};d.open("POST",b.xdrURL.call(c,e.url(b.url,{id:b.id})));d.send("data="+g)}:function(c){var d,f=p.createElement("form");f.action=e.url(b.url,{id:b.id});f.target="socket-"+v++;f.method="POST";f.enctype=f.encoding="text/plain";f.acceptCharset="UTF-8";f.style.display="none";f.innerHTML='<textarea name="data"></textarea><iframe name="'+f.target+'"></iframe>';
f.firstChild.value=c;d=f.lastChild;e.on(d,"error",function(){a(c)});e.on(d,"load",function(){p.body.removeChild(f)});p.body.appendChild(f);f.submit()};return f},sse:function(c,b){var a,f=h.EventSource,g=q.httpbase(c,b);if(f&&!(b.crossOrigin&&e.browser.safari&&7>e.browser.vmajor))return g.open=function(){var b=g.uri.open();a=new f(b,{withCredentials:!0});a.onopen=function(){c.fire("open")};a.onmessage=function(a){c.receive(a.data)};a.onerror=function(){a.close();c.fire("close")}},g.abort=function(){a.close()},
g},streambase:function(c,b){var a="",f=q.httpbase(c,b);f.parse=function(b){if(b=b.replace(/^\s+/,"")){var d=(a+b).split("\n\n");for(b=0;b<d.length-1;b++)c.receive(d[b].substring(6));a=d[d.length-1]}};return f},streamxhr:function(c,b){var a,f=q.streambase(c,b);if(!(e.browser.msie&&10>e.browser.vmajor||e.browser.opera&&13>e.browser.vmajor||b.crossOrigin&&!e.corsable))return f.open=function(){var b,d,k=f.uri.open();a=e.xhr();a.onreadystatechange=function(){3===a.readyState&&200===a.status?(d=a.responseText.length,
b?d>b&&f.parse(a.responseText.substring(b)):(c.fire("open"),f.parse(a.responseText)),b=d):4===a.readyState&&(200!==a.status&&c.fire("error",Error()),c.fire("close"))};a.open("GET",k);e.corsable&&(a.withCredentials=!0);a.send(null)},f.abort=function(){a.abort()},f},streamxdr:function(c,b){var a,f=h.XDomainRequest,g=q.streambase(c,b);if(f&&b.xdrURL)return g.open=function(){var d,e,h=b.xdrURL.call(c,g.uri.open());a=new f;a.onprogress=function(){e=a.responseText.length;d?g.parse(a.responseText.substring(d)):
(c.fire("open"),g.parse(a.responseText));d=e};a.onerror=function(){c.fire("error",Error()).fire("close")};a.onload=function(){c.fire("close")};a.open("GET",h);a.send()},g.abort=function(){a.abort()},g},streamiframe:function(c,b){var a,f,e=h.ActiveXObject,d=q.streambase(c,b);if(e&&!b.crossOrigin){try{new e("htmlfile")}catch(k){return}d.open=function(){function b(a){var c;(function s(){c=setTimeout(function(){!1!==a()&&s()},1)})();return function(){clearTimeout(c)}}var k,h,m=d.uri.open();a=new e("htmlfile");
a.open();a.close();k=a.createElement("iframe");k.src=m;a.body.appendChild(k);h=k.contentDocument||k.contentWindow.document;f=b(function(){function a(){var b;b=e.cloneNode(!0);b.appendChild(h.createTextNode("."));b=b.innerText.replace(/\r\n/g,"\n");return b.substring(0,b.length-1)}var e;if(h.firstChild){e=h.body.lastChild;if(!e)return c.fire("error",Error()).fire("close"),!1;c.fire("open");d.parse(a());e.innerText="";f=b(function(){var b=a();b&&(e.innerText="",d.parse(b));if("complete"===h.readyState)return c.fire("close"),
!1});return!1}})};d.abort=function(){f();a.execCommand("Stop")};return d}},longpollbase:function(c,b){var a=q.httpbase(c,b);a.uri.poll=function(a){return e.url(b.url,{id:b.id,when:"poll",lastEventIds:a.join(",")})};a.open=function(){a.connect(a.uri.open(),function(){function b(g){a.connect(a.uri.poll(g),function(a){if(a){var g=[];a=e.parseJSON(a);var h=e.isArray(a)?a:[a];for(a=0;a<h.length;a++)g.push(h[a].id);b(g);for(a=0;a<h.length;a++)c.receive(e.stringifyJSON(h[a]))}else c.fire("close")})}b([]);
c.fire("open")})};return a},longpollajax:function(c,b){var a,f=q.longpollbase(c,b);if(!b.crossOrigin||e.corsable)return f.connect=function(b,d){a=e.xhr();a.onreadystatechange=function(){4===a.readyState&&(200===a.status?d(a.responseText):c.fire("error",Error()))};a.open("GET",b);e.corsable&&(a.withCredentials=!0);a.send(null)},f.abort=function(){a.abort()},f},longpollxdr:function(c,b){var a,f=h.XDomainRequest,e=q.longpollbase(c,b);if(f&&b.xdrURL)return e.connect=function(d,e){d=b.xdrURL.call(c,d);
a=new f;a.onload=function(){e(a.responseText)};a.onerror=function(){c.fire("error",Error()).fire("close")};a.open("GET",d);a.send()},e.abort=function(){a.abort()},e},longpolljsonp:function(c,b){var a,f=A.pop()||"socket_"+v++,e=q.longpollbase(c,b);h[f]=function(b){a.responseText=b};c.once("close",function(){h[f]=function(){};A.push(f)});e.uri._open=e.uri.open;e.uri.open=function(){return e.uri._open.apply(e,arguments)+"&callback="+f};e.connect=function(b,e){a=p.createElement("script");a.async=!0;a.src=
b;a.clean=function(){a.clean=a.onerror=a.onload=a.onreadystatechange=null;a.parentNode&&a.parentNode.removeChild(a)};a.onload=a.onreadystatechange=function(){if(!a.readyState||/loaded|complete/.test(a.readyState))a.clean&&a.clean(),e(a.responseText)};a.onerror=function(){a.clean();c.fire("error",Error()).fire("close")};x.insertBefore(a,x.firstChild)};e.abort=function(){a.clean&&a.clean()};return e}},B={},w=[];B.open=function(c,b){var a=y(c,b);w.push(a);return a};B.util=e;B.transports=q;e.on(h,"unload",
function(){D=!0;var c,b;for(c=0;c<w.length;c++)b=w[c],"closed"!==b.state()&&b.close()});e.on(h,"online",function(){var c,b;for(c=0;c<w.length;c++)b=w[c],"waiting"===b.state()&&b.open()});e.on(h,"offline",function(){var c,b;for(c=0;c<w.length;c++)b=w[c],"opened"===b.state()&&b.fire("error",Error()).fire("close")});return B});